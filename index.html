<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AdExclusion Enterprise</title>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    
    <script>
      window.process = { env: { API_KEY: "" } };

      async function fetchAndTransform(path) {
        const response = await fetch(path);
        if (!response.ok) throw new Error(`Failed to fetch ${path}`);
        let code = await response.text();
        
        // Clean imports for dynamic loading in sandbox
        code = code
          .replace(/import\s+React,\s+{[^}]*}\s+from\s+['"]react['"];?/g, (m) => `const {${m.match(/{([^}]*)}/)[1]}} = window.React;`)
          .replace(/import\s+React\s+from\s+['"]react['"];?/g, '')
          .replace(/import\s+{([^}]*)}\s+from\s+['"]react['"];?/g, 'const {$1} = window.React;')
          .replace(/import\s+{([^}]*)}\s+from\s+['"]@google\/genai['"];?/g, 'const {$1} = window.genAI;')
          // Services
          .replace(/import\s+{[^}]*authService[^}]*}\s+from\s+['"]\.\/.*authService\.ts['"];?/g, 'const { authService } = window.AuthModule;')
          .replace(/import\s+{[^}]*dataService[^}]*}\s+from\s+['"]\.\/.*dataService\.ts['"];?/g, 'const { dataService } = window.DataModule;')
          // Shared logic (Types and Constants) - Support both ./ and ../
          .replace(/import\s+{[^}]*}\s+from\s+['"]\.\.?\/types(\.ts)?['"];?/g, (m) => `const {${m.match(/{([^}]*)}/)[1]}} = window.TypesModule;`)
          .replace(/import\s+{[^}]*}\s+from\s+['"]\.\.?\/constants(\.ts)?['"];?/g, (m) => `const {${m.match(/{([^}]*)}/)[1]}} = window.ConstantsModule;`)
          // Components
          .replace(/import\s+{[^}]*RuleForm[^}]*}\s+from\s+['"]\.\/components\/RuleForm\.tsx['"];?/g, 'const { RuleForm } = window.RuleFormModule;')
          .replace(/import\s+{[^}]*RuleList[^}]*}\s+from\s+['"]\.\/components\/RuleList\.tsx['"];?/g, 'const { RuleList } = window.RuleListModule;')
          .replace(/import\s+{[^}]*IntegrationPreview[^}]*}\s+from\s+['"]\.\/components\/IntegrationPreview\.tsx['"];?/g, 'const { IntegrationPreview } = window.IntegrationModule;')
          .replace(/import\s+{[^}]*Sandbox[^}]*}\s+from\s+['"]\.\/components\/Sandbox\.tsx['"];?/g, 'const { Sandbox } = window.SandboxModule;')
          // Remove remaining local imports (handle both ./ and ../)
          .replace(/import\s+.*\s+from\s+['"]\.\.?\/[^'"]*['"];?/g, '');

        return Babel.transform(code, {
          presets: [
            [Babel.availablePresets['typescript'], { allExtensions: true, isTSX: true }],
            [Babel.availablePresets['react'], { runtime: 'classic' }]
          ],
          filename: path
        }).code;
      }

      async function bootstrap() {
        const root = document.getElementById('root');
        try {
          const [React, ReactDOM, genAI] = await Promise.all([
            import('https://esm.sh/react@18.3.1'),
            import('https://esm.sh/react-dom@18.3.1/client'),
            import('https://esm.sh/@google/genai@1.38.0')
          ]);
          
          window.React = React.default || React;
          window.ReactDOM = ReactDOM.default || ReactDOM;
          window.genAI = genAI;

          // Sequential load to satisfy dependencies
          const loadModule = async (name, path) => {
            const code = await fetchAndTransform(path);
            const blob = new Blob([code], { type: 'application/javascript' });
            window[name] = await import(URL.createObjectURL(blob));
          };

          // Load base logic first
          await loadModule('TypesModule', './types.ts');
          await loadModule('ConstantsModule', './constants.ts');
          await loadModule('AuthModule', './services/authService.ts');
          await loadModule('DataModule', './services/dataService.ts');
          
          // Load components
          await loadModule('RuleFormModule', './components/RuleForm.tsx');
          await loadModule('RuleListModule', './components/RuleList.tsx');
          await loadModule('IntegrationModule', './components/IntegrationPreview.tsx');
          await loadModule('SandboxModule', './components/Sandbox.tsx');

          const appCode = await fetchAndTransform('./App.tsx');
          const appBlob = new Blob([appCode], { type: 'application/javascript' });
          const { default: App } = await import(URL.createObjectURL(appBlob));

          window.ReactDOM.createRoot(root).render(window.React.createElement(App));
        } catch (e) {
          console.error(e);
          root.innerHTML = `<div style="padding:40px;text-align:center;font-family:sans-serif;"><h1>System Error</h1><p>${e.message}</p></div>`;
        }
      }
      window.addEventListener('load', bootstrap);
    </script>
    <style>
      body { font-family: 'Inter', sans-serif; background: #f8fafc; margin: 0; }
      #root:empty::after { content: "DNEVNIK.hr ADEX"; display: block; text-align: center; margin-top: 45vh; font-weight: 900; color: #b71918; letter-spacing: 0.2em; animation: fade 1s infinite; }
      @keyframes fade { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
      .custom-scrollbar::-webkit-scrollbar { width: 6px; }
      .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
      .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.3.1",
    "react-dom/": "https://esm.sh/react-dom@18.3.1/",
    "react/": "https://esm.sh/react@18.3.1/",
    "@google/genai": "https://esm.sh/@google/genai@1.38.0"
  }
}
</script>
</head>
<body>
    <div id="root"></div>
</body>
</html>